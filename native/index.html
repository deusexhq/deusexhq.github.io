



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation for Deus Ex">
      
      
      
        <meta name="author" content="Kaiser">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.2">
    
    
      
        <title>Native Coding - Deus Ex</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../kaiser.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#introduction" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Deus Ex" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Deus Ex
            </span>
            <span class="md-header-nav__topic">
              Native Coding
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/deusexhq/deusexhq.github.io" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Deus Ex" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Deus Ex
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/deusexhq/deusexhq.github.io" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://discord.gg/KUA8acb" title="<img src="https://cdn.discordapp.com/emojis/457155649831305219.png" width="20" height="20" border="0" />Discord" class="md-nav__link">
      <img src="https://cdn.discordapp.com/emojis/457155649831305219.png" width="20" height="20" border="0" />Discord
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Deus Ex General Documentation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Deus Ex General Documentation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../dxms/" title="Masterserver Fix" class="md-nav__link">
      Masterserver Fix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../community/" title="Community" class="md-nav__link">
      Community
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hx/" title="HX Co-op" class="md-nav__link">
      HX Co-op
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../coding/" title="Coding" class="md-nav__link">
      Coding
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Native Coding
      </label>
    
    <a href="./" title="Native Coding" class="md-nav__link md-nav__link--active">
      Native Coding
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" title="Introduction" class="md-nav__link">
    Introduction
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#consider-the-benefits" title="Consider the Benefits" class="md-nav__link">
    Consider the Benefits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#be-wary-of-the-thorns" title="Be Wary of the Thorns" class="md-nav__link">
    Be Wary of the Thorns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creation" title="Creation" class="md-nav__link">
    Creation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-up-the-package" title="Set up the Package" class="md-nav__link">
    Set up the Package
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-the-public-header-file" title="Generate the Public Header File" class="md-nav__link">
    Generate the Public Header File
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-the-private-header-file" title="Make the Private Header File" class="md-nav__link">
    Make the Private Header File
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hack-the-c-source-code" title="Hack the C++ Source Code" class="md-nav__link">
    Hack the C++ Source Code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mind-the-macros" title="Mind the Macros" class="md-nav__link">
    Mind the Macros
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-the-result" title="Return the Result" class="md-nav__link">
    Return the Result
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tweak-the-c-compiler-settings" title="Tweak the C++ Compiler Settings" class="md-nav__link">
    Tweak the C++ Compiler Settings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-by-step-guide" title="Step-by-step guide" class="md-nav__link">
    Step-by-step guide
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hosting/" title="Hosting" class="md-nav__link">
      Hosting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../improvements/" title="Improvements" class="md-nav__link">
      Improvements
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mapping/" title="Mapping" class="md-nav__link">
      Mapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../multiplayer/" title="Multiplayer" class="md-nav__link">
      Multiplayer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../playing/" title="Playing" class="md-nav__link">
      Playing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../singleplayer/" title="Singleplayer Mods" class="md-nav__link">
      Singleplayer Mods
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../troubleshooting/" title="Troubleshooting" class="md-nav__link">
      Troubleshooting
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Object Documentation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Object Documentation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../object/" title="Object" class="md-nav__link">
      Object
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../actor/" title="Actor" class="md-nav__link">
      Actor
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../game/" title="Game" class="md-nav__link">
      Game
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../inventory/" title="Inventory" class="md-nav__link">
      Inventory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../pawn/" title="Pawn" class="md-nav__link">
      Pawn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../player/" title="Player" class="md-nav__link">
      Player
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../file/" title="Files" class="md-nav__link">
      Files
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" title="Introduction" class="md-nav__link">
    Introduction
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#consider-the-benefits" title="Consider the Benefits" class="md-nav__link">
    Consider the Benefits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#be-wary-of-the-thorns" title="Be Wary of the Thorns" class="md-nav__link">
    Be Wary of the Thorns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creation" title="Creation" class="md-nav__link">
    Creation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-up-the-package" title="Set up the Package" class="md-nav__link">
    Set up the Package
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-the-public-header-file" title="Generate the Public Header File" class="md-nav__link">
    Generate the Public Header File
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-the-private-header-file" title="Make the Private Header File" class="md-nav__link">
    Make the Private Header File
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hack-the-c-source-code" title="Hack the C++ Source Code" class="md-nav__link">
    Hack the C++ Source Code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mind-the-macros" title="Mind the Macros" class="md-nav__link">
    Mind the Macros
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-the-result" title="Return the Result" class="md-nav__link">
    Return the Result
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tweak-the-c-compiler-settings" title="Tweak the C++ Compiler Settings" class="md-nav__link">
    Tweak the C++ Compiler Settings
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-by-step-guide" title="Step-by-step guide" class="md-nav__link">
    Step-by-step guide
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Native Coding</h1>
                
                <div class="tcalert">
Guide originally written by <em>Tom "Blitz" Conder</em> and <em>Carlos "c0mpi1e" Cuello</em>.<br>
Dated: 9/13/1999<br> 
Directions also are written for Unreal rather than Deus Ex. You should be able to replace any references to Unreal with Deus Ex though.
</div>

<hr>

<h4 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">#</a></h4>
<p>The Unreal engine has the ability to mix Unrealscript (UScript) and C++ code. In order
to call C++ functions from UScript you must compile them into a dynamic-link library (DLL)
file. Calling these functions, known as native functions, is probably one of most
overlooked features of Unreal. This document will discuss implementing native functions,
identify a few gotchas and give a step-by-step guide to a basic example.</p>
<h5 id="consider-the-benefits">Consider the Benefits<a class="headerlink" href="#consider-the-benefits" title="Permanent link">#</a></h5>
<p>By far one of the most impressive features of Unreal is its highly modularized and
replaceable game code. Amateurs can modify the game by replacing or augmenting its code,
sounds, meshes and levels with their own. These modifications called &#145;mods&#146; are
the concern of an entire online community. Mods keep Unreal fresh and interesting and give
it life long after most have solved the original. Native functions are one of the tools in
the toolchest of mod authors. They allow for algorithmic textures, performance-critical
artificial intelligence, access to the Win32 API and implementation hiding.</p>
<h5 id="be-wary-of-the-thorns">Be Wary of the Thorns<a class="headerlink" href="#be-wary-of-the-thorns" title="Permanent link">#</a></h5>
<p>There are disadvantages to using native functions. First of all, the process is
complicated and not well documented. Although this document will shed some light on
process, writing them is unsupported by Epic Games. Secondly, forget Mac compatibility.
Writing DLLs means that your mod will only work in Microsoft Windows. Lastly, every patch
will break your mod. UScript is more portable between patches, particularly beta patches.
Also, C++ headers and library files are needed to compile DLLs. That means you need the
latest public source to compile your DLL.</p>
<h4 id="creation">Creation<a class="headerlink" href="#creation" title="Permanent link">#</a></h4>
<h5 id="set-up-the-package">Set up the Package<a class="headerlink" href="#set-up-the-package" title="Permanent link">#</a></h5>
<p>Mod authors should start by setting up a new package. A package file is a file that
contains a collection of related objects, eg. textures, sounds and scripts. Package files
containing UScript classes are identified with a <code>.u</code> extension.</p>
<p>Unreal comes with its own compiler capable of producing package files. It is called
<code>ucc.exe</code> and is found in the <code>Unreal\System</code> directory. We will
discuss using the compiler later.</p>
<p>Start your mod by making a directory under the Unreal folder with the name of your
project. For example, if your project is named <code>Hazard</code>, then create a directory named
<code>Unreal\Hazard</code>. </p>
<p>Next, create four directories under your package folder named Classes, Inc, Src and
Lib. The Classes directory will hold your UScript. The Inc directory will hold the public
header files. The Src directory will hold your C++ files and private header files. The Lib
directory will hold static library file created during the compilation.</p>
<p>In order for your new package to be seen by the Unreal Editor, the ucc compiler and
during gameplay you need to edit the Unreal.ini file. It is located in the <code>Unreal\System</code>
directory. Find the <code>[Editor.EditorEngine]</code> section and add <code>Hazard</code> to the [EditPackages]
list, eg. <code>EditPackages=Hazard</code>. </p>
<p>We discussed how to set up a new package. We took a look at the Unreal compiler,
created the needed directories and edited the appropriate initialization file. Now that
the system is ready, it is time to use the Unreal compiler to automatically generate the
public header file.</p>
<h5 id="generate-the-public-header-file">Generate the Public Header File<a class="headerlink" href="#generate-the-public-header-file" title="Permanent link">#</a></h5>
<p>Classes that use native functions must be declared as native in UScript. Unreal always
looks for C++ implementation of native function in a DLL corresponding to the class's
package name. For example, if your package is named <code>Hazard</code>, Unreal will look for a file
named <code>Hazard.dll</code> in the System directory.</p>
<p>The following example implements a class named <code>hzTest</code>. It is a subclass of
another class named Actor. Notice we declare your class as native.</p>
<pre><code>class hzTest extends Actor 
native;
</code></pre>

<p>The Unreal compiler, ucc, will read the class file and
automatically generate a header file which you can include in your DLL project. Be careful
not to edit this file as the Unreal compiler will see that it has changed and offer to
overwrite it. Although Epic's documentation recommends running the ucc compiler as an
external tool through Visual C++, you do not want to do it for this step. Run the ucc
compiler from the DOS prompt, eg. <code>ucc make</code>. Since the compiler prompts you for a
response and the prompt does not show up in VC++ output window, it appears in fact to hang
the C++ compiler.</p>
<p>Running ucc from the DOS prompt is easy. Simply, go to the DOS prompt. Find the
<code>Unreal\System</code> directory. Now type: <code>ucc make</code>. Eventually the resulting prompt
will appear:</p>
<pre><code>The file '..\Hazard\Inc\HazardClasses.h' needs to be updated. Do you want to overwrite the existing version? (Y/N)
</code></pre>

<p>When prompted, press the <code>Y</code> key to answer in the affirmative.</p>
<p>We generated out public header file. This file exposes functions declarations and
definitions to other classes. Lets move on implementing the private header file.</p>
<h5 id="make-the-private-header-file">Make the Private Header File<a class="headerlink" href="#make-the-private-header-file" title="Permanent link">#</a></h5>
<p>A private header file contains local definitions and structures that we do not want to
expose to other classes. The private header file must include the engine, core and public
header files. The following file, <code>HazardPrivate.h</code>, is an example of a private header file.</p>
<pre><code>// =========================================================================== 
// Project: Native Function Document 
// 
// Description: 
// This is the header file for the native function document DLL. 
// ===========================================================================

#include &quot;Engine.h&quot; 
#include &quot;Core.h&quot;

// The HazardClasses header file is automatically generated by the ucc 
// compiler. 
#include &quot;HazardClasses.h&quot;
</code></pre>

<p>We wrote our private header file. Any private structure or
definitions go here. Now we are to implement the C++ source file.</p>
<h5 id="hack-the-c-source-code">Hack the C++ Source Code<a class="headerlink" href="#hack-the-c-source-code" title="Permanent link">#</a></h5>
<p>Write your C++ file. Be sure to include your private header file. Take a look at the
following example, a file named hzTest.cpp.</p>
<pre><code>// =========================================================================== 
// Project: Native Function Document 
// 
// Description: 
// This file contains code for the native function document DLL. 
// ===========================================================================

#include &quot;HazardPrivate.h&quot;

IMPLEMENT_PACKAGE(Hazard);

IMPLEMENT_CLASS(AhzTest);

IMPLEMENT_FUNCTION(AhzTest, 1700, execIncTest);

// execIncTest - called as IncTest method in UScript 
void 
AhzTest::execIncTest (FFrame&amp; Stack, RESULT_DECL) 
{ 
    // input parameter handling 
    guard(AhzTest::execIncTest); 
    P_FINISH;

    GLog-&gt;Logf(TEXT(&quot;in IncTest() &quot;));

    iTest++;

    // return the result 
    *(DWORD*)Result = iTest;

    unguardexec; 
}
</code></pre>

<p>This example simply increments the value of a variable named <code>iTest</code> by one and returns
the resulting value. The next section explains the macros used in this example and
describes a few more.</p>
<h5 id="mind-the-macros">Mind the Macros<a class="headerlink" href="#mind-the-macros" title="Permanent link">#</a></h5>
<p>When implementing native functions in C++ you need to learn some of the macros found in
the source code. The above code example uses a few of them: <code>IMPLEMENT_PACKAGE</code>,
<code>IMPLEMENT_CLASS</code>, <code>IMPLEMENT_FUNCTION</code> and <code>P_FINISH</code>, <code>guard()</code>, <code>unguard</code>.</p>
<p><code>IMPLEMENT_PACKAGE()</code> - takes as a parameter the name of the package; takes the parameter in the form <code>IMPLEMENT_PACKAGE(MyPackage);</code> </p>
<p><code>IMPLEMENT_CLASS()</code> - takes as a parameter the name of the class in the form:
<code>IMPLEMENT_CLASS(MyClassName);</code> </p>
<p><code>IMPLEMENT_FUNCTION()</code> - declaration macro to expose the function to the source file;
takes three parameters in the form: <code>IMPLEMENT_FUNCTION( AClassName, UniqueID,AFunctionName);</code></p>
<p>where <code>AClassName</code> is the name of your class, <code>UniqueID*</code> is an integer that
is to uniquely identify the function. This number must be unique to any package loaded in
Unreal. For example you can have multiple functions with the same name in your package,
they could be in different classes, the numbers are what tells the Unreal which function
to call. Unreal uses several numbers for its functions throughout the
<code>Engine/Unreali/UnrealShare/Core/Fire</code> etc package files. However, most of those stay below
approximately 500, and depending on which packages are loaded by Unreal, you may use
those, too. Personally, I try and keep all of mine above 1000.</p>
<p><code>P_GET_UBOOL</code>, <code>P_GET_STRUCT</code>, <code>P_GET_INT</code>, etc. - These macros grab the variable off of
the call stack.</p>
<p>Let us take the following example with a native function declared in UScript and C++: </p>
<pre><code>native function FunctionName( int x, int y, bool bDo); 
// UScript
</code></pre>

<pre><code>void execFunctionName( FFrame &amp;amp;Stack, void* Result ); 
// C++
</code></pre>

<p>Now those two declarations look very different. How do you get those parameters?
Well, the answer lies in the use of the Stack and the <code>P_</code> macros. The stack frame contains
the current function states, including the parameters. FFrame &amp;Stack is a reference to
the current stack frame and state. The <code>P_GET*</code> macros grab the parameters off of the stack.
You must use the <code>P_GET*</code> calls to grab the parameter types in the same order
as is defined in UScript. </p>
<p>In our example, we would want to do the following </p>
<pre><code>void MyClass::execFunctionName( FFrame &amp;amp;Stack,
void const *Result )
{ 
 guard( MyClass::execFunctionName ); 

 P_GET_INT( x ); 
 P_GET_INT( y ); 
 P_GET_UBOOL( bDo ); 

 P_FINISH;


 // Do what we want. 

unguard; 
} 
</code></pre>

<p>The <code>P_GET*</code> macros all perform the same function functions although they might look a little different depending on the type. For a complete listing of all of the macros, look at <code>Unreal\Core\Inc\UnScript.h</code> </p>
<p><code>P_GET_UBOOL_OPTX</code>, <code>P_GET_INT_OPTX</code>, etc. - used in the same way as the regular <code>P_GET</code>
macros, but add on an extra parameter, the default value. For example, following the previous code listing:</p>
<pre><code>native function Foo( optional int x = 10, optional int y = 10 ); 
void MyClass::execFoo( FFrame &amp;Stack, void const *Result )
{ 
     guard( MyClass::execFoo ); 
     P_GET_INT_OPTX( x, 10 ); 
     P_GET_INT_OPTX( x, 10 ); 
     P_FINISH;

     // Do what we want.


     if ( x == 10 )
          GLog-&gt;Log( TEXT( &quot;Using defaults&quot; ) ); 
     unguard; 
}
</code></pre>

<p><code>P_GET_ARRAY_REF</code>, <code>P_GET_STR_REF</code>, etc. - used in the exact same way as the <code>P_GET*</code> macros (not the optional macros), and allows parameters to be paseed by reference. For example: </p>
<pre><code>native function Foo( out int x, out int y ); 
void MyClass::execFoo( FFrame &amp;Stack, void const *Result )
{ 
     guard( MyClass::execFoo ); 
     P_GET_INT_REF( x ); 
     P_GET_INT_REF( x ); 
     P_FINISH;

     // Do what we want.

     unguard; 
}
</code></pre>

<p><code>P_FINISH</code> - indicates the end of the call stack. You must put this in your
native functions or Unreal will crash by not closing up the stack and trying to
load a new function, state or class.</p>
<p><code>guard()</code>, <code>unguard</code> - creates an exception handler for the following block of code.
Basically, it translates to a try/catch block, and adds a name to unwinding stack.
Here is the usage:</p>
<p><code>guard(MyClass::MyFunction)</code> or <code>guard(CoolBlockOfCode)</code></p>
<p>If an exception is raised in the block of code wrapped by a guard, then the log file
will show the relevant stack info, including the deepest stack name, eg.: </p>
<pre><code>void MyFunc()
{ 
    guard(MyClass::MyFunc);

    // Do something to raise an exception

    unguard; 
}
</code></pre>

<p>This code will cause the log file to give not only the relevant error, but also where in
the code it happened. You can add as many <code>guard()</code>'s in a function as you want, the more
you do it, the more specific an error will be. </p>
<p>I once started a function that had about 20 lines of code. An error was being thrown
somewhere. I started narrowing it down, adding <code>guard()</code>s and unguard statements everywhere.
Finally I narrowed it down to the specific line.</p>
<h5 id="return-the-result">Return the Result<a class="headerlink" href="#return-the-result" title="Permanent link">#</a></h5>
<p>Native functions can return values. Unreal defined a variable named 'Result'. To return
a value from a function set the value of the variable equal to the returned value. Since
the returned value it cast to its desired type it is possible to return just about
anything from a function including integers, float and references to user-defined
structures.</p>
<p>Now that we have taken a look at C++ source code, let us move on to the final step:
compiling the source code into a DLL file. Unfortunately, in order to get your code to
compile successfully you will need to customize the compiler setting. We will take a look
at that in the next section.</p>
<h5 id="tweak-the-c-compiler-settings">Tweak the C++ Compiler Settings<a class="headerlink" href="#tweak-the-c-compiler-settings" title="Permanent link">#</a></h5>
<p>The Visual C++ compiler settings must be tweaked in order for the DLL to be compiled.
First of all the preprocessor settings must be changed. In the Preprocessor category under
the C/C++ compiler options tab, remove the existing preprocessor setting and replaced them
with: <code>WIN32,WINDOWS,_WINDOWS,UNICODE,_UNICODE,HAZARD_API=__declspec(dllexport)</code> </p>
<p>These settings tell the compiler to use the Win32 API, Unicode and to give the
<code>HAZARD_API</code> a definition. The <code>HAZARD_API</code> defition is important become the generated header
file has a bug where it sets <code>HAZARD_API</code> to <code>DLL_IMPORT</code>. In actually we want the defintion
to indicate dll exports, so defining it here works around the problem without editing the
automatically generated header file. </p>
<p>Also, in the preprocessor tab set the additional include directories to point to the
core, engine and package include directories. That is, set it to:
<code>..\..\Core\Inc,..\..\Engine\Inc,..\Inc</code> </p>
<p>Secondly, the link settings must be changed. In the General category under the Link
options tab, set the output file name to: ....\System/Hazard.dll. Additionally, set the
Object/library modules to point to the core and engine library files. That is, set it to:
<code>..\..\Core\Lib\Core.lib ..\..\Engine\Lib\Engine.lib</code></p>
<h4 id="step-by-step-guide">Step-by-step guide<a class="headerlink" href="#step-by-step-guide" title="Permanent link">#</a></h4>
<p>What you need to have before starting:</p>
<p>. a copy of Unreal; patched to version 224v 
. a copy of the Unreal public source  224v, contains C++ headers and library files 
. a copy of Microsoft Visual C++ 6.0; service packs recommended 
. a simple text editor (notepad.exe works just fine)</p>
<ul>
<li>Make a new project folder below the Unreal folder. For this tutorial, we will use <code>Unreal\Hazard</code></li>
</ul>
<pre><code>Unreal\ 
+- Hazard 
+- Cache 
+- System 
+- ... 
</code></pre>

<ul>
<li>In this folder, create four new folders: 'Classes', 'Inc', 'Src' and 'Lib' </li>
</ul>
<pre><code>Unreal\Hazard\ 
+- Classes 
+- Inc 
+- Src 
+- Lib
</code></pre>

<ul>
<li>Change to the <code>Unreal\Hazard\Classes</code> directory. The next step will take place there. </li>
<li>Create a file named <code>hzTest.uc</code>. Use your editor to edit it. </li>
</ul>
<pre><code>//============================================================================= 
// hzTest 
//============================================================================= 
class hzTest extends Actor 
native; 

var int iTest; // test variable
// native function - implemented in DLL 
native(1700) final function int IncTest();

auto state Default 
{ 
    event PreBeginPlay() 
    { 
        Super.PreBeginPlay(); 
        Log (&quot;hzTest was called.&quot;); 
    }

function Timer()
{ 
    IncTest();
    Log (&quot;Value = &quot; $ iTest); 
}

Begin: 
    SetTimer(5.0, True); 
}

defaultproperties 
{ 
DrawType=DT_Mesh 
Mesh=LodMesh'UnrealI.KrallM' 
}
</code></pre>

<ul>
<li>Change to the <code>Unreal\System directory</code>. The next three steps will take place there. </li>
<li>Locate the Unreal.ini file. </li>
</ul>
<p>In the <code>[Editor.EditorEngine]</code> section add 'Hazard' to the <code>[EditPackages]</code> list. Eg. <code>EditPackages=Hazard</code>
This tells the Unreal Editor to load the package on startup. It also tells the ucc compiler to scan the directory when it does its compilation. </p>
<ul>
<li>In the <code>Unreal\System directory</code>, delete the <code>Hazard.u</code> file if it exists. </li>
</ul>
<p>Of course, if this is your first time through the tutorial, this file will not exist. However, if it does exist, it must be deleted. </p>
<ul>
<li>Type <code>ucc make</code> to run the Unreal compiler. </li>
<li>Watch the progress of the compiler. You should eventually see a prompt like this:</li>
</ul>
<pre><code>The file '..\Hazard\Inc\HazardClasses.h' needs to be updated. Do you want to overwrite the existing version? (Y/N) 
</code></pre>

<p>Answer yes by pressing 'Y'. </p>
<ul>
<li>Open the Microsoft Visual C++ compiler. Define a new workspace named <code>Hazard</code>. On my computer Unreal is installed to <code>E:\Games\Unreal</code>, adjust the directory name to match the directory where Unreal is installed on your computer. </li>
</ul>
<p>Go to <code>File-&gt;New-&gt;Workspaces</code>
Workspace name: <code>Hazard</code> 
Location: <code>E:\Games\unreal\Hazard</code> </p>
<ul>
<li>Create a new project named <code>Hazard DLL</code>. </li>
</ul>
<p>Go to <code>File-&gt;New-&gt;Projects</code>
<strong>Win32 Dynamic-Link Library</strong>
Project Name: <code>Hazard DLL</code>
Location: <code>E:\Games\unreal\Hazard\Src</code>
Add to current workspace: <code>An empty DLL project</code> </p>
<ul>
<li>Create a new header file named <code>HazardPrivate.h</code>. </li>
</ul>
<p><code>File-&gt;New-&gt;Files</code>
<strong>C/C++ Header File</strong>
Add to project: <code>Hazard DLL</code>
File name: <code>HazardPrivate.h</code>
Location: <code>E:\Games\unreal\Hazard\Src</code></p>
<ul>
<li>Edit HazardPrivate.h</li>
</ul>
<pre><code>// =========================================================================== 
// Project: Native Function Tutorial 
// 
// Description: 
// This is the header file for the native function tutorial DLL. 
// ===========================================================================

#include &quot;Engine.h&quot; 
#include &quot;Core.h&quot;

// The HazardClasses header file is automatically generated by the ucc 
// compiler. 
#include &quot;HazardClasses.h&quot; 
</code></pre>

<ul>
<li>Add the automatically generated header file, <code>HazardClasses.h</code> to the project. </li>
</ul>
<p>Right click on the 'Hazard DLL files' in FileView of the Workspace window </p>
<p><code>Add Files to Project..</code></p>
<p>Choose <code>Inc</code>. Then select the file named <code>HazardClasses.h</code></p>
<ul>
<li>Create a new file named <code>hzTest.cpp</code>. </li>
</ul>
<p><code>File-&gt;New-&gt;Files</code>
<strong>C++ Source File</strong> 
Add to project: <code>Hazard DLL</code>
File name: <code>hzTest.cpp</code>
Location: <code>E:\Games\unreal\Hazard\Src</code></p>
<ul>
<li>Edit hzTest.cpp</li>
</ul>
<pre><code>// =========================================================================== 
// Project: Native Function Tutorial 
// 
// Description: 
// This file contains code for the native function tutorial DLL. 
// ===========================================================================

#include &quot;HazardPrivate.h&quot;

IMPLEMENT_PACKAGE(Hazard);

IMPLEMENT_CLASS(AhzTest);

IMPLEMENT_FUNCTION (AhzTest, 1700, execIncTest);

// execIncTest - called as IncTest method in UnrealScript 
void 
AhzTest::execIncTest (FFrame&amp; Stack, RESULT_DECL)
{
    // input parameter handling 
    guard (AhzTest::execIncTest); 
    P_FINISH;

    GLog-&gt;Logf( TEXT(&quot;in IncTest() &quot;) );

    iTest++;

    // return the result 
    *(DWORD*)Result = iTest;

    unguardexec; 
} 
</code></pre>

<ul>
<li>Before we compile, we need to set a few compiler options. First of all, remove the Debug configuration. </li>
</ul>
<p><code>Build-&gt;Configurations..</code>
Remove the configuration named <code>Win32 Debug</code> and close this window. </p>
<ul>
<li>Tweak the C/C++ compiler options. </li>
</ul>
<p><code>Project-&gt;Settings..</code> 
<strong>C/C++ tab in the Preprocessor category</strong>
Preprocesser Defintions: <code>WIN32,WINDOWS,_WINDOWS,UNICODE,_UNICODE,HAZARD_API=__declspec(dllexport)</code>
Additional include directories: <code>..\..\Core\Inc,..\..\Engine\Inc,..\Inc</code></p>
<ul>
<li>Change the Link compiler options </li>
</ul>
<p><code>Project-&gt;Settings..</code>
<strong>Link tab in the General category</strong>
Output file name: <code>..\..\System/Hazard.dll</code>
Object/library modules: <code>..\..\Core\Lib\Core.lib ..\..\Engine\Lib\Engine.lib</code></p>
<ul>
<li>Now is a good time to save your work, <code>File-&gt;Save All</code> </li>
<li>Compile. <code>Build-&gt;Build Hazard.dll</code></li>
<li>Run the game with a test map. For example, type this at the DOS prompt: <code>unreal DmAriza.unr ?log=hztest.log</code></li>
<li>In the game go to the console, type: <code>showlog</code> </li>
<li>After log window opens return to the console. Now type: <code>summon hazard.hztest</code></li>
<li>A model of a Kraal should appear. Watch the log window. You see something like this:</li>
</ul>
<pre><code>    Log: in IncTest()  
    ScriptLog: Value = 1 
    Log: in IncTest()  
    ScriptLog: Value = 2 
</code></pre>

<ul>
<li>Now exit the game.  Excellent job on getting your first native function to run!</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../coding/" title="Coding" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Coding
              </span>
            </div>
          </a>
        
        
          <a href="../hosting/" title="Hosting" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Hosting
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            © Kaiser and the Deus Ex HQ team, 2019
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.d9aa80ab.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>